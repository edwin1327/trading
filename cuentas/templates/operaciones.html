{% extends 'base.html' %}

{% block content %}

<div class="container">
    <h2>Información de la cuenta</h2>
    {% if account_info_df %}
        <!-- TODO: Eliminar línea cuando se termine de obtener todos los datos {{ account_info_df | safe }} -->
        {{ account_info_df | safe }}
        <p>Saldo de la cuenta: ${{ saldo }}</p>
    {% else %}
        <p>No se pudo obtener información de la cuenta.</p>
    {% endif %}
</div>
<div class="container">
    <form method="post">
        {% csrf_token %} {# Añade el token CSRF aquí #}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Divisa</th>
                    <th>Timeframe</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for estrategia_usuario in estrategias_usuario %}
                <tr>
                    <td>{{ estrategia_usuario.nombre_estrategia }}</td>
                    <td>{{ estrategia_usuario.divisa }}</td>
                    <td>{{ estrategia_usuario.timeframe }}</td>
                    <td>
                        <td>
                            {% if estrategia_usuario.estado %}
                                <button type="checkbox" class="btn btn-success toggle-estado" data-estrategia-id="{{ estrategia_usuario.id }}">Activo</button>
                            {% else %}
                                <button type="button" class="btn btn-danger toggle-estado" data-estrategia-id="{{ estrategia_usuario.id }}">Inactivo</button>
                            {% endif %}
                                <button type="button" class="btn btn-primary ejecutar-codigo" data-estrategia-id="{{ estrategia_usuario.id }}">Ejecutar Código</button>
                        </td>
                        
                        
                    </td>
                    <td>
                        <a href="#" class="btn btn-warning">Editar</a>
                        <a href="#" class="btn btn-danger">Eliminar</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <a href="{% url 'crear_estrategia' %}" class="btn btn-primary">Agregar Estrategia</a>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $('.toggle-estado').on('click', function() {
            var button = $(this);  // Guarda una referencia al botón actual
            var estrategiaId = button.data('estrategia-id');
            
            // Obtener el token CSRF
            var csrfToken = $("[name=csrfmiddlewaretoken]").val();

            // Hacer una solicitud AJAX para cambiar el estado
            $.ajax({
                url: "{% url 'cambiar_estado_estrategia' %}",
                method: "POST",
                data: {
                    'estrategia_id': estrategiaId,
                    'csrfmiddlewaretoken': csrfToken  // Agregar el token CSRF aquí
                },
                success: function(response) {
                    // Cambia el estado en la interfaz según la respuesta
                    if (response.estado === true) {
                        button.text('Activo').removeClass('btn-danger').addClass('btn-success');
                        
                    } else {
                        button.text('Inactivo').removeClass('btn-success').addClass('btn-danger');
                    }
                }
            });
        });
        $('.ejecutar-codigo').on('click', function() {
            var estrategiaId = $(this).data('estrategia-id');
            
            // Hacer una solicitud AJAX para ejecutar el código Python
            $.ajax({
                url: "{% url 'ejecutar_codigo_python' estrategia_id=0 %}".replace('0', estrategiaId),
                method: "GET",
                success: function(response) {
                    alert(response.mensaje);  // Muestra el mensaje de ejecución
                }
            });
        });
    });
</script>

{% endblock %}
